# Guide de D√©veloppement - Task Management API

> **Note** : Ce fichier se trouve dans le dossier `server/` et contient la documentation technique d√©taill√©e du backend. Pour la documentation g√©n√©rale du projet, voir `README.md` √† la racine.

## üìö Architecture et Concepts

### üîê Logiques des Permissions Admin/User

#### **R√¥les et Permissions**

| R√¥le      | Permissions                                                                                                                                                                             | Restrictions                                                                                                         |
| --------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------- |
| **User**  | ‚Ä¢ Cr√©er des t√¢ches (pour soi-m√™me)<br>‚Ä¢ Modifier le statut (si assign√©/cr√©ateur)<br>‚Ä¢ Modifier la priorit√© (si cr√©ateur)<br>‚Ä¢ Supprimer (si cr√©ateur)<br>‚Ä¢ Voir toutes les t√¢ches       | ‚Ä¢ Ne peut assigner qu'√† soi-m√™me<br>‚Ä¢ Ne peut pas modifier l'assignation<br>‚Ä¢ Ne peut pas modifier titre/description |
| **Admin** | ‚Ä¢ Toutes les permissions user<br>‚Ä¢ Cr√©er des t√¢ches pour n'importe qui<br>‚Ä¢ Modifier l'assignation<br>‚Ä¢ Modifier la priorit√© de toutes les t√¢ches<br>‚Ä¢ Supprimer n'importe quelle t√¢che | ‚Ä¢ Aucune restriction                                                                                                 |

#### **Logique de Permissions dans les Contr√¥leurs**

```javascript
// Socket.IO - Mise √† jour de t√¢che
const isAdmin = socket.user.role === "admin";
const isCreator = task.createdBy.toString() === socket.user._id.toString();

const allowedFields = isAdmin
  ? ["status", "priority", "assignedTo"] // Admin : tout
  : isCreator
  ? ["status", "priority"] // Cr√©ateur : statut + priorit√©
  : ["status"]; // Autres : statut seulement
```

#### **S√©curit√© Multi-niveaux**

1. **Front-end** : Interface adapt√©e selon les permissions
2. **Back-end** : Validation stricte des permissions
3. **Base de donn√©es** : Contraintes au niveau du sch√©ma
4. **Socket.IO** : Authentification et autorisation

---

### üîÑ Cycle de Vie d'une Task

#### **1. Cr√©ation**

```javascript
// Flux de cr√©ation
User ‚Üí Front-end ‚Üí Validation ‚Üí Back-end ‚Üí Database ‚Üí Socket.IO ‚Üí Notifications
```

**√âtapes :**

- **Validation** : Express-validator + Mongoose schema
- **Permissions** : V√©rification des droits de cr√©ation
- **Assignation** : Auto-assignation pour non-admin
- **Notification** : Toast √† l'utilisateur assign√©
- **Broadcast** : Mise √† jour de la liste pour tous

#### **2. Modification**

```javascript
// Flux de modification
User ‚Üí Front-end ‚Üí Validation ‚Üí Back-end ‚Üí Permissions ‚Üí Database ‚Üí Socket.IO ‚Üí Notifications
```

**Champs modifiables :**

- **Statut** : `pending` ‚Üí `in_progress` ‚Üí `completed`/`cancelled`
- **Priorit√©** : `low` ‚Üí `medium` ‚Üí `high` ‚Üí `urgent`
- **Assignation** : Changement d'utilisateur assign√© (admin seulement)

#### **3. Suppression**

```javascript
// Flux de suppression
User ‚Üí Confirmation ‚Üí Back-end ‚Üí Permissions ‚Üí Database ‚Üí Socket.IO ‚Üí Notifications
```

**Permissions :**

- **Cr√©ateur** : Peut supprimer sa t√¢che
- **Admin** : Peut supprimer n'importe quelle t√¢che
- **Autres** : Pas de permission

#### **4. √âtats de la T√¢che**

| √âtat          | Description | Transitions possibles        |
| ------------- | ----------- | ---------------------------- |
| `pending`     | En attente  | ‚Üí `in_progress`, `cancelled` |
| `in_progress` | En cours    | ‚Üí `completed`, `cancelled`   |
| `completed`   | Termin√©e    | ‚Üí `in_progress` (retour)     |
| `cancelled`   | Annul√©e     | ‚Üí `pending` (retour)         |

---

### üë§ Cycle de Vie d'un User/Admin

#### **1. Inscription**

```javascript
// Flux d'inscription
User ‚Üí Front-end ‚Üí Validation ‚Üí Back-end ‚Üí Hash Password ‚Üí Database ‚Üí JWT ‚Üí Login
```

**Validation :**

- Email unique et valide
- Mot de passe fort (8+ caract√®res, majuscule, minuscule, chiffre)
- Username unique (3-30 caract√®res alphanum√©riques)

#### **2. Connexion**

```javascript
// Flux de connexion
User ‚Üí Credentials ‚Üí Validation ‚Üí Back-end ‚Üí Verify Password ‚Üí JWT ‚Üí Socket.IO
```

**S√©curit√© :**

- Token JWT avec expiration
- Refresh token en HttpOnly cookie
- Authentification Socket.IO

#### **3. Session Active**

```javascript
// Gestion de session
JWT ‚Üí Middleware ‚Üí User Context ‚Üí Socket.IO Room ‚Üí Real-time Updates
```

**Fonctionnalit√©s :**

- Acc√®s aux t√¢ches selon les permissions
- Notifications en temps r√©el
- Mise √† jour automatique de l'interface

#### **4. D√©connexion**

```javascript
// Flux de d√©connexion
User ‚Üí Logout ‚Üí Clear JWT ‚Üí Disconnect Socket.IO ‚Üí Clear State
```

---

### üîî Cycle de Vie des Notifications

#### **1. Types de Notifications**

| Type           | D√©clencheur           | Destinataire                    | Message                                       |
| -------------- | --------------------- | ------------------------------- | --------------------------------------------- |
| `task_created` | Cr√©ation de t√¢che     | Utilisateur assign√©             | "Nouvelle t√¢che assign√©e: [titre]"            |
| `task_updated` | Modification de t√¢che | Utilisateur assign√©             | "T√¢che [titre] mise √† jour par [utilisateur]" |
| `task_deleted` | Suppression de t√¢che  | Utilisateur assign√©             | "T√¢che supprim√©e par [utilisateur]"           |
| `task_error`   | Erreur d'op√©ration    | Utilisateur qui a fait l'action | Message d'erreur sp√©cifique                   |

#### **2. Flux de Notification**

```javascript
// Flux complet
Action ‚Üí Back-end ‚Üí Socket.IO ‚Üí Room ‚Üí Client ‚Üí Toast Store ‚Üí UI
```

**√âtapes d√©taill√©es :**

1. **Action utilisateur** : Cr√©ation/modification/suppression
2. **Validation serveur** : Permissions et donn√©es
3. **√âmission Socket.IO** : `task_notification` vers la room de l'assign√©
4. **R√©ception client** : `handleTaskNotification` dans Dashboard
5. **Toast Store** : `notifyTaskCreated/Updated/Deleted`
6. **Affichage UI** : Toast avec message appropri√©

#### **3. Syst√®me de Rooms Socket.IO**

```javascript
// Gestion des rooms
User Connection ‚Üí Join Room `user_${userId}` ‚Üí Targeted Notifications
```

**Avantages :**

- Notifications cibl√©es (seulement l'assign√©)
- Pas de spam pour les autres utilisateurs
- Mise √† jour de liste pour tous (broadcast s√©par√©)

#### **4. Gestion des Erreurs de Notification**

```javascript
// Fallback en cas d'√©chec
Socket.IO Error ‚Üí HTTP API ‚Üí Error Toast ‚Üí User Feedback
```

---

### ‚ùå Cycle de Vie des Erreurs

#### **1. Types d'Erreurs**

| Type                 | Niveau      | Gestion           | Exemple                     |
| -------------------- | ----------- | ----------------- | --------------------------- |
| **Validation**       | Front-end   | Toast d'erreur    | "Titre requis"              |
| **Authentification** | Middleware  | Redirection login | "Token expir√©"              |
| **Autorisation**     | Contr√¥leur  | Toast d'erreur    | "Permissions insuffisantes" |
| **Base de donn√©es**  | Utilitaires | Log + Toast       | "Erreur interne"            |
| **Socket.IO**        | Service     | Toast d'erreur    | "Connexion perdue"          |

#### **2. Flux de Gestion d'Erreur**

```javascript
// Flux d'erreur
Error ‚Üí Handler ‚Üí Log ‚Üí Response ‚Üí Client ‚Üí Toast ‚Üí User
```

**Niveaux de gestion :**

1. **Validation** : Express-validator + Mongoose
2. **Middleware** : Authentification + Permissions
3. **Contr√¥leur** : Logique m√©tier + Permissions
4. **Utilitaires** : Gestion centralis√©e des erreurs
5. **Client** : Affichage utilisateur + Retry

#### **3. Gestion Centralis√©e**

```javascript
// Utilitaires d'erreur
export const handleServerError = (error, res, operation) => {
  if (process.env.NODE_ENV === "development") {
    console.error(`‚ùå Erreur lors de ${operation}:`, error);
  }
  return res.status(500).json({
    success: false,
    message: "Erreur interne du serveur",
  });
};
```

#### **4. Logs et Debug**

```javascript
// Strat√©gie de logging
Development ‚Üí Console d√©taill√©
Production ‚Üí Logs essentiels seulement
```

---

### üèóÔ∏è M√©thodes Static et Priv√©es

#### **Pourquoi utiliser des m√©thodes static ?**

```javascript
class TaskController {
  // ‚úÖ STATIC : Pas d'instance n√©cessaire
  static async createTask(req, res) { ... }
  static async getTasks(req, res) { ... }

  // ‚ùå INSTANCE : N√©cessite new TaskController()
  async createTask(req, res) { ... }
}
```

**Avantages :**

- **Simplicit√©** : Pas de gestion d'instances
- **Performance** : Pas d'allocation m√©moire
- **Stateless** : Pas d'√©tat partag√© entre requ√™tes
- **Express-friendly** : Compatible avec les middlewares Express

#### **Pourquoi utiliser des m√©thodes priv√©es ?**

```javascript
class TaskController {
  // ‚úÖ PUBLIC : Interface claire
  static async createTask(req, res) { ... }

  // ‚úÖ PRIV√â : D√©tails cach√©s
  static #handleValidationErrors(req, res) { ... }
  static #populateTaskReferences(taskId) { ... }
}
```

**Avantages :**

- **Encapsulation** : Cache la complexit√© interne
- **S√©curit√©** : Contr√¥le d'acc√®s aux m√©thodes sensibles
- **Maintenance** : √âvolution sans casser l'API publique
- **Lisibilit√©** : Interface claire et professionnelle

---

### ‚úÖ Express-Validators vs Schemas MongoDB

#### **Pourquoi les deux ?**

```javascript
// üóÑÔ∏è Schema MongoDB (Validation structurelle)
const taskSchema = new mongoose.Schema({
  title: { type: String, required: true, maxlength: 200 },
  priority: { type: String, enum: ["low", "medium", "high"] },
  dueDate: { type: Date, min: Date.now },
});

// ‚úÖ Express-Validator (Validation m√©tier)
export const createTaskValidation = [
  body("title")
    .trim()
    .isLength({ min: 3, max: 200 })
    .withMessage("Le titre doit contenir entre 3 et 200 caract√®res"),
  body("dueDate")
    .isISO8601()
    .custom((value) => new Date(value) > new Date())
    .withMessage("La date d'√©ch√©ance doit √™tre dans le futur"),
];
```

#### **Diff√©rences et Compl√©mentarit√©**

| Aspect           | Schema MongoDB      | Express-Validator          |
| ---------------- | ------------------- | -------------------------- |
| **Niveau**       | Base de donn√©es     | Couche applicative         |
| **Timing**       | Avant sauvegarde    | Avant traitement           |
| **Complexit√©**   | Validation simple   | Validation m√©tier complexe |
| **Messages**     | Messages g√©n√©riques | Messages personnalis√©s     |
| **Sanitisation** | Basique             | Avanc√©e                    |

#### **Avantages des Express-Validators**

1. **Validation M√©tier Complexe**

```javascript
body("password")
  .matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/)
  .withMessage("Mot de passe trop faible");
```

2. **Messages d'Erreur Personnalis√©s**

```javascript
body("email").isEmail().withMessage("Veuillez fournir un email valide");
```

3. **Sanitisation des Donn√©es**

```javascript
body('email').normalizeEmail(),
body('username').trim().escape(),
```

4. **Performance**

```javascript
// Validation avant traitement co√ªteux
const validation = validationResult(req);
if (!validation.isEmpty()) {
  return res.status(400).json({ errors: validation.array() });
}
// Seulement apr√®s validation ‚Üí requ√™te DB
```

---

## üéØ Architecture Compl√®te

### **Flux de Donn√©es**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           Front-end (React)         ‚îÇ
‚îÇ  ‚îú‚îÄ Zustand Stores (State)          ‚îÇ
‚îÇ  ‚îú‚îÄ Socket.IO Client (Real-time)    ‚îÇ
‚îÇ  ‚îî‚îÄ Axios (HTTP API)                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ           Socket.IO Server          ‚îÇ
‚îÇ  ‚îú‚îÄ Authentication                  ‚îÇ
‚îÇ  ‚îú‚îÄ Real-time Events               ‚îÇ
‚îÇ  ‚îî‚îÄ Notifications                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ           Express Server            ‚îÇ
‚îÇ  ‚îú‚îÄ Routes (API Endpoints)          ‚îÇ
‚îÇ  ‚îú‚îÄ Controllers (Business Logic)    ‚îÇ
‚îÇ  ‚îú‚îÄ Middlewares (Auth/Validation)   ‚îÇ
‚îÇ  ‚îî‚îÄ Validators (Data Validation)    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ           MongoDB (Database)        ‚îÇ
‚îÇ  ‚îú‚îÄ Schemas (Data Structure)        ‚îÇ
‚îÇ  ‚îú‚îÄ Indexes (Performance)           ‚îÇ
‚îÇ  ‚îî‚îÄ Validation (Data Integrity)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **S√©curit√© Multi-niveaux**

1. **Front-end** : Validation c√¥t√© client + Interface adapt√©e
2. **Socket.IO** : Authentification + Rooms personnalis√©es
3. **Express** : Middlewares d'authentification + Validation
4. **MongoDB** : Contraintes de sch√©ma + Index de s√©curit√©

### **Performance et Scalabilit√©**

- **Index MongoDB** : Optimisation des requ√™tes fr√©quentes
- **Socket.IO Rooms** : Notifications cibl√©es
- **Validation pr√©coce** : √âvite les traitements inutiles
- **Gestion d'erreur centralis√©e** : Logs et monitoring
